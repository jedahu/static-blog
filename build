#!/bin/sh

CDPATH=''

while true; do
  if [ -f sbrc ] || [ -f sbrc.xml ]; then
    break
  elif [ "$PWD" = '/' ]; then
    echo 'No sbrc or sbrc.xml found.' >&2
    exit 1
  else
    cd ..
  fi
done

CONF="$(pwd)/sbrc.xml"
[ -f sbrc ] && CONF="$(pwd)/sbrc"

shopt -s extglob
LATEST='-1'
cd posts
for x in +([0-9]); do
  [ "$x" -gt "$LATEST" ] && LATEST="$x"
done
cd ..

(echo '<files xmlns="http://github.com/jedahu/static-blog">'
while read f; do
  if [ ${f:0:1} = '/' ]; then
    echo "$f"
  else
    echo "$(pwd)/$f"
  fi
done
echo '</files>') | \
  java -cp "${0%/*}/saxon9he.jar" net.sf.saxon.Transform \
  -s:- \
  -xsl:"_sb/sb.xsl" \
  sbrc="$CONF" \
  latest-post="$LATEST" \
  files="$FILES"
